<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />

    <title>Document</title>
  </head>

  <body>
    <style>
      .chant-content {
        height: 350px;
        overflow-y: scroll;
      }
      .line {
        margin-top: 10px;
        display: flex;
      }
      .chat-box {
        background-color: #eee;
        padding: 5px;
        max-width: 200px;
      }
      .mine {
        margin-left: auto;
      }
    </style>
    <div class="chat-content">
      <div class="line">
        <span class="chat-box">안녕?</span>
      </div>
      <div class="line">
        <span class="chat-box mine">안녕!</span>
      </div>
    </div>
    <input class="chat-box" id="input" />
    <button id="send">전송</button>

    <script type="module">
      import { Configuration, OpenAIApi } from 'https://cdn.skypack.dev/openai';
      document.querySelector('#send').addEventListener('click', function(){
          var template = `<div class="line">
              <span class="chat-box mine">${ document.querySelector('#input').value }</span>
          </div>`
          document.querySelector('.chat-content').insertAdjacentHTML('beforeend',template);
          
          var express = require('express');
          var app = express();
          var request = require('request');
          var { OpenAIApi, Configuration } = require('openai');

          let config = new Configuration({
            apiKey: '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',
          });
          let openai = new OpenAIApi(config);

          app.get('/', function(req,res){
            res.sendFile(__dirname + '/index.html')
          })

          var client_id = '96doCFCMnxe944Gngjpn';
          var client_secret =
          
          app.get('/translate', function (req, res) {
            var api_url = 'https://openapi.naver.com/v1/papago/n2mt';
            var query = req.query.q;

            var options = {
              url: api_url,
              form: {'source':'ko', 'target':'en', 'text':query},
              headers: 'X-Naver-Client-Id':client_id, 'X-Naver-Client-Secret':client_secret}
      
            request.post(options, funtion(error, response,body) {
              var English = JSON.parse(body).message?.result.translatedText;
            
              openai.createCompletion({
                model: "text-davinci-003",
                prompt: English,
                temperature: 1,
                max_tokens: 256,
                top_p: 1,
                frequency_penalty: 0,
                presence_penalty: 0,
              }).then((result)=>{
                console.log('ai 응답', result.data.choices[0].text);
              
              var api_url = 'https://openapi.naver.com/v1/papago/n2mt';
              var query = result.data.choices[0].text;
              var options = {
                  url: api_url,
                  form: {'source':'en', 'target':'ko', 'text':query},
                  headers: {'X-Naver-Client-Id':client_id, 'X-Naver-Client-Secret':client_secret}
              };
              request.post(options, funtion (error, response, body){
                console.log(body);
                res.status(200).json(body);

              });
            

            }).catch((error)=>{
              console.log('openai error',error)
            })
          });
          
        });
      });

      app.listen(300, function () {
        console.log('https://localhost:3000/translate app listening on port 3000!');
      });
    </script>
  </body>
</html>